{% extends "layout.html" %}

{% block title %}
    Admin
{% endblock %}

{% block main %}

<div class="container colored-container">
    <div class="section d-flex justify-content-between align-items-center">
        <h2>Van Identifications</h2>
        <button id="openAddVanPopup" class="btn btn-primary">Add Van</button>
    </div>

    <!-- Search bar placed above the table -->
    <input type="text" id="searchBar" class="form-control mb-3" placeholder="Search">

    <!-- Single table element containing the table -->
    <table id="vanTable" class="table table-bordered">
        <thead>
            <tr>
                <th>Van</th>
                <th>VIN Number</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for van in vans %}
                <tr data-id="{{ van.id }}">
                    <td class="van-code">{{ van.van_code }}</td>
                    <td class="van-vin">{{ van.vin }}</td>
                    <td>
                        <!-- EDIT (popup) -->
                        <button
                            type="button"
                            class="btn btn-sm btn-warning edit-van-btn"
                            data-id="{{ van.id }}"
                            data-code="{{ van.van_code }}"
                            data-vin="{{ van.vin }}"
                            data-edit-url="{{ url_for('edit_van', van_id=van.id) }}"
                        >
                            Edit
                        </button>

                        <!-- DELETE (SweetAlert confirm) -->
                        <button
                            type="button"
                            class="btn btn-sm btn-danger delete-van-btn"
                            data-id="{{ van.id }}"
                            data-code="{{ van.van_code }}"
                            data-delete-url="{{ url_for('delete_van', van_id=van.id) }}"
                        >
                            Delete
                        </button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Van Popup -->
<div id="addVanPopup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
        <span id="closeAddVanPopup" class="popup-close">&times;</span>
        <h3>Add Van</h3>
        <form id="addVanForm" method="post" action="{{ url_for('admin') }}">
            <div class="form-group">
                <label for="van_code">Van:</label>
                <input type="text" id="van_code" name="van_code" class="form-control" placeholder="e.g. G59" required>
            </div>
            <div class="form-group">
                <label for="vin">VIN:</label>
                <input type="text" id="vin" name="vin" class="form-control" placeholder="VIN Number" required>
            </div>
            <button type="submit" class="btn btn-success mt-2">Save</button>
        </form>
    </div>
</div>

<!-- Edit Van Popup -->
<div id="editVanPopup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
        <span id="closeEditVanPopup" class="popup-close">&times;</span>
        <h3>Edit Van</h3>
        <form id="editVanForm" method="post">
            <div class="form-group">
                <label for="edit_van_code">Van:</label>
                <input type="text" id="edit_van_code" name="van_code" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit_vin">VIN:</label>
                <input type="text" id="edit_vin" name="vin" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-success mt-2">Save Changes</button>
        </form>
    </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Make all current vans available to JS
const existingVans = [
    {% for van in vans %}
    { id: {{ van.id }}, code: "{{ van.van_code }}", vin: "{{ van.vin }}" }{% if not loop.last %},{% endif %}
    {% endfor %}
];

document.addEventListener('DOMContentLoaded', function () {

    // Keep track of original values for the Edit popup
    let originalCode = '';
    let originalVin  = '';

    // =========================
    // SEARCH BAR
    // =========================
    const searchBar = document.getElementById('searchBar');
    if (searchBar) {
        searchBar.addEventListener('input', function () {
            const query = this.value.toUpperCase();
            const rows = document
                .getElementById('vanTable')
                .getElementsByTagName('tbody')[0]
                .getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const cols = rows[i].getElementsByTagName('td');
                let rowMatchesQuery = false;
                const columnsToCheck = [0, 1]; // Van + VIN

                for (let j = 0; j < columnsToCheck.length; j++) {
                    const cellText = cols[columnsToCheck[j]].innerText.toUpperCase();
                    if (cellText.includes(query)) {
                        rowMatchesQuery = true;
                        break;
                    }
                }
                rows[i].style.display = rowMatchesQuery ? '' : 'none';
            }
        });
    }

    // =========================
    // ADD VAN POPUP + PREFIX + CONFLICT CHECK
    // =========================
    const openAddBtn  = document.getElementById('openAddVanPopup');
    const addPopup    = document.getElementById('addVanPopup');
    const closeAddBtn = document.getElementById('closeAddVanPopup');

    const addVanForm       = document.getElementById('addVanForm');
    const addVanCodeInput  = document.getElementById('van_code');
    const addVinInput      = document.getElementById('vin');

    if (openAddBtn && addPopup && closeAddBtn) {
        openAddBtn.addEventListener('click', function () {
            addPopup.style.display = 'block';
        });

        closeAddBtn.addEventListener('click', function () {
            addPopup.style.display = 'none';
        });

        addPopup.addEventListener('click', function (e) {
            if (e.target === addPopup) {
                addPopup.style.display = 'none';
            }
        });
    }

    if (addVanForm && addVanCodeInput && addVinInput) {
        addVanForm.addEventListener('submit', function (e) {
            e.preventDefault();

            let vanCode = addVanCodeInput.value.trim().toUpperCase();
            let vin     = addVinInput.value.trim().toUpperCase();

            if (!vanCode || !vin) {
                addVanForm.submit();
                return;
            }

            // ----- PREFIX VALIDATION (G/H/L) -----
            const prefix = vanCode.charAt(0);
            const number = vanCode.substring(1);
            const validPrefix = ['G', 'H', 'L'];

            if (!validPrefix.includes(prefix)) {

                // numeric part must be valid
                if (!/^\d+$/.test(number)) {
                    Swal.fire({
                        title: 'Invalid Van Number',
                        text: 'Van must start with G, H, or L followed by a number (e.g., G5).',
                        icon: 'error'
                    });
                    return;
                }

                Swal.fire({
                    title: 'Invalid Van Prefix',
                    html: `
                        <p>The van <strong>${vanCode}</strong> is not valid.</p>
                        <p>Did you mean one of these?</p>
                    `,
                    showCloseButton: true,
                    closeButtonHtml: '<span style="color:red; font-size:1.6rem;">âœ–</span>',
                    showCancelButton: true,
                    showDenyButton: true,
                    showConfirmButton: true,
                    confirmButtonText: `G${number}`,
                    denyButtonText: `H${number}`,
                    cancelButtonText: `L${number}`,
                    confirmButtonColor: '#007bff',
                    denyButtonColor: '#007bff',
                    cancelButtonColor: '#007bff',
                }).then((result) => {
                    if (result.isConfirmed) {
                        addVanCodeInput.value = `G${number}`;
                        addVanForm.submit();
                    } else if (result.isDenied) {
                        addVanCodeInput.value = `H${number}`;
                        addVanForm.submit();
                    } else if (result.dismiss === Swal.DismissReason.cancel) {
                        addVanCodeInput.value = `L${number}`;
                        addVanForm.submit();
                    }
                });

                return; // stop here; weâ€™ll resubmit after user chooses
            }

            // ----- CONFLICT CHECKS -----
            const sameCode = existingVans.find(v => v.code === vanCode);
            const sameVin  = existingVans.find(v => v.vin === vin);

            // CASE 1: same van code exists â†’ offer "merge to new VIN"
            if (sameCode) {
                Swal.fire({
                    title: 'Van Already Exists',
                    html: `
                        <div style="text-align:left;">
                            <p><strong>Van:</strong> ${vanCode}</p>
                            <hr>
                            <p><strong>Existing VIN:</strong> ${sameCode.vin}</p>
                            <p><strong>New VIN:</strong> ${vin}</p>
                            <p style="margin-top:10px;font-size:0.9rem;color:#555;">
                                If you continue, the existing van's VIN will be updated
                                to the new value. You can always EDIT it later.
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Merge to new VIN',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#b00000'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/vans/${sameCode.id}/edit`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                van_code: vanCode,
                                vin: vin
                            })
                        })
                        .then(resp => {
                            if (!resp.ok) throw new Error('Network error');
                            window.location.reload();
                        })
                        .catch(err => {
                            console.error(err);
                            Swal.fire('Error', 'Could not update van. Please try again.', 'error');
                        });
                    }
                });

                return;
            }

            // CASE 2: VIN already used by a different van â†’ warn but allow
            if (sameVin) {
                Swal.fire({
                    title: 'VIN Conflict',
                    html: `
                        <div style="text-align:left;">
                            <p>The VIN <strong>${vin}</strong> is already assigned.</p>
                            <p><strong>Existing van:</strong> ${sameVin.code}</p>
                            <p><strong>New van:</strong> ${vanCode}</p>
                            <p style="margin-top:10px;font-size:0.9rem;color:#555;">
                                This will create two vans with the same VIN.
                                You can EDIT or DELETE one later.
                            </p>
                        </div>
                    `,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Continue & Add',
                    cancelButtonText: 'Cancel',
                    confirmButtonColor: '#007bff'
                }).then((result) => {
                    if (result.isConfirmed) {
                        addVanForm.submit();
                    }
                });

                return;
            }

            // CASE 3: no conflicts â†’ just submit normally
            addVanForm.submit();
        });
    }

    // =========================
    // EDIT VAN POPUP 
    // =========================
    const editPopup        = document.getElementById('editVanPopup');
    const closeEditBtn     = document.getElementById('closeEditVanPopup');
    const editForm         = document.getElementById('editVanForm');
    const editVanCodeInput = document.getElementById('edit_van_code');
    const editVinInput     = document.getElementById('edit_vin');

    if (editPopup && editForm && editVanCodeInput && editVinInput) {
        document.querySelectorAll('.edit-van-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const code = this.dataset.code;
                const vin  = this.dataset.vin;
                const editUrl = this.dataset.editUrl;

                originalCode = code;
                originalVin  = vin;

                editVanCodeInput.value = code;
                editVinInput.value = vin;
                editForm.action = editUrl;

                editPopup.style.display = 'block';
            });
        });

        if (closeEditBtn) {
            closeEditBtn.addEventListener('click', function () {
                editPopup.style.display = 'none';
            });

            editPopup.addEventListener('click', function (e) {
                if (e.target === editPopup) {
                    editPopup.style.display = 'none';
                }
            });
        }

        editForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const newCode = editVanCodeInput.value.trim().toUpperCase();
            const newVin  = editVinInput.value.trim().toUpperCase();

            if (newCode === originalCode && newVin === originalVin) {
                this.submit();
                return;
            }

            Swal.fire({
                title: 'Confirm Edit',
                html: `
                    <div style="text-align:left;">
                        <p><strong>Van (old):</strong> ${originalCode}</p>
                        <p><strong>Van (new):</strong> ${newCode}</p>
                        <hr>
                        <p><strong>VIN (old):</strong> ${originalVin}</p>
                        <p><strong>VIN (new):</strong> ${newVin}</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#b00000'
            }).then((result) => {
                if (result.isConfirmed) {
                    editForm.submit();
                }
            });
        });
    }

    // =========================
    // DELETE VAN (SweetAlert confirm + success)
    // =========================
    document.querySelectorAll('.delete-van-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            const row       = this.closest('tr');
            const code      = this.dataset.code;
            const deleteUrl = this.dataset.deleteUrl;

            Swal.fire({
                title: 'Delete Van',
                html: 'Are you sure you want to delete van <strong>' + code + '</strong>?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(deleteUrl, {
                        method: 'POST'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        if (row) {
                            row.remove();
                        }

                        Swal.fire({
                            title: '<span style="font-size: 2.5rem; display:block; margin-bottom: 10px;">ðŸ—‘</span>Van Deleted',
                            html: 'Van <strong>' + code + '</strong> has been removed.',
                            background: '#ffffff',
                            color: '#000000',
                            confirmButtonColor: '#b00000',
                            confirmButtonText: 'Close'
                        });
                    })
                    .catch(error => {
                        console.error('Error deleting van:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'There was a problem deleting this van. Please try again.',
                            icon: 'error',
                            confirmButtonText: 'Close'
                        });
                    });
                }
            });
        });
    });

});
</script>

{% endblock %}

