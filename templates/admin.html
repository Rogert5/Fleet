{% extends "layout.html" %}

{% block title %}
    Admin
{% endblock %}

{% block main %}

<div class="container colored-container">
    <div class="section d-flex justify-content-between align-items-center">
        <h2>Van Identifications</h2>
        <button id="openAddVanPopup" class="btn btn-primary">Add Van</button>
    </div>

    <!-- Search bar placed above the table -->
    <input type="text" id="searchBar" class="form-control mb-3" placeholder="Search">

    <!-- Single table element containing the table -->
    <table id="vanTable" class="table table-bordered">
        <thead>
            <tr>
                <th>Van</th>
                <th>VIN Number</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for van in vans %}
                <tr data-id="{{ van.id }}">
                    <td class="van-code">{{ van.van_code }}</td>
                    <td class="van-vin">{{ van.vin }}</td>
                    <td>
                        <!-- EDIT (popup) -->
                        <button
                            type="button"
                            class="btn btn-sm btn-warning edit-van-btn"
                            data-id="{{ van.id }}"
                            data-code="{{ van.van_code }}"
                            data-vin="{{ van.vin }}"
                            data-edit-url="{{ url_for('edit_van', van_id=van.id) }}"
                        >
                            Edit
                        </button>

                        <!-- DELETE (SweetAlert confirm) -->
                        <button
                            type="button"
                            class="btn btn-sm btn-danger delete-van-btn"
                            data-id="{{ van.id }}"
                            data-code="{{ van.van_code }}"
                            data-delete-url="{{ url_for('delete_van', van_id=van.id) }}"
                        >
                            Delete
                        </button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Van Popup -->
<div id="addVanPopup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
        <span id="closeAddVanPopup" class="popup-close">&times;</span>
        <h3>Add Van</h3>
        <form method="post" action="{{ url_for('admin') }}">
            <div class="form-group">
                <label for="van_code">Van:</label>
                <input type="text" id="van_code" name="van_code" class="form-control" placeholder="e.g. G59" required>
            </div>
            <div class="form-group">
                <label for="vin">VIN:</label>
                <input type="text" id="vin" name="vin" class="form-control" placeholder="VIN Number" required>
            </div>
            <button type="submit" class="btn btn-success mt-2">Save</button>
        </form>
    </div>
</div>

<!-- Edit Van Popup -->
<div id="editVanPopup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
        <span id="closeEditVanPopup" class="popup-close">&times;</span>
        <h3>Edit Van</h3>
        <form id="editVanForm" method="post">
            <div class="form-group">
                <label for="edit_van_code">Van:</label>
                <input type="text" id="edit_van_code" name="van_code" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit_vin">VIN:</label>
                <input type="text" id="edit_vin" name="vin" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-success mt-2">Save Changes</button>
        </form>
    </div>
</div>


<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

    // =========================
    // SEARCH BAR
    // =========================
    const searchBar = document.getElementById('searchBar');
    if (searchBar) {
        searchBar.addEventListener('input', function() {
            const query = this.value.toUpperCase();
            const rows = document
                .getElementById('vanTable')
                .getElementsByTagName('tbody')[0]
                .getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const cols = rows[i].getElementsByTagName('td');
                let rowMatchesQuery = false;
                const columnsToCheck = [0, 1]; // Van + VIN

                for (let j = 0; j < columnsToCheck.length; j++) {
                    const cellText = cols[columnsToCheck[j]].innerText.toUpperCase();
                    if (cellText.includes(query)) {
                        rowMatchesQuery = true;
                        break;
                    }
                }
                rows[i].style.display = rowMatchesQuery ? '' : 'none';
            }
        });
    }

    // =========================
    // ADD VAN POPUP
    // =========================
    const openAddBtn = document.getElementById('openAddVanPopup');
    const addPopup   = document.getElementById('addVanPopup');
    const closeAddBtn = document.getElementById('closeAddVanPopup');

    if (openAddBtn && addPopup && closeAddBtn) {
        openAddBtn.addEventListener('click', function () {
            addPopup.style.display = 'block';
        });

        closeAddBtn.addEventListener('click', function () {
            addPopup.style.display = 'none';
        });

        addPopup.addEventListener('click', function (e) {
            if (e.target === addPopup) {
                addPopup.style.display = 'none';
            }
        });
    }

    // =========================
    // EDIT VAN POPUP 
    // =========================
    const editPopup = document.getElementById('editVanPopup');
    const closeEditBtn = document.getElementById('closeEditVanPopup');
    const editForm = document.getElementById('editVanForm');
    const editVanCodeInput = document.getElementById('edit_van_code');
    const editVinInput = document.getElementById('edit_vin');

    if (editPopup && editForm && editVanCodeInput && editVinInput) {
        document.querySelectorAll('.edit-van-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                const code = this.dataset.code;
                const vin  = this.dataset.vin;
                const editUrl = this.dataset.editUrl;

                editVanCodeInput.value = code;
                editVinInput.value = vin;
                editForm.action = editUrl;

                editPopup.style.display = 'block';
            });
        });

        if (closeEditBtn) {
            closeEditBtn.addEventListener('click', function () {
                editPopup.style.display = 'none';
            });

            editPopup.addEventListener('click', function (e) {
                if (e.target === editPopup) {
                    editPopup.style.display = 'none';
                }
            });
        }
    }

    // =========================
    // DELETE VAN (SweetAlert confirm + success)
    // =========================
    document.querySelectorAll('.delete-van-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            const row  = this.closest('tr');
            const code = this.dataset.code;
            const deleteUrl = this.dataset.deleteUrl;

            Swal.fire({
                title: 'Delete Van',
                html: 'Are you sure you want to delete van <strong>' + code + '</strong>?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(deleteUrl, {
                        method: 'POST'
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        // Remove row from the table
                        if (row) {
                            row.remove();
                        }

                        // Show confirmation popup with van code
                        Swal.fire({
                            title: 'Van Deleted',
                            html: 'Van <strong>' + code + '</strong> has been removed.',
                            imageUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACRUlEQVR4nO2b0W3DMBRFTwIAVgBAJABMgARyAB3IADZABNUAEpAMiAEQgARkgAu2dJIpMEI2vFXZkzqR5v9u9+f8v375+hT8g0VJKvH8gZC8Jt3xJ2C7V78k/IvM8QHc6WhiAhtoYGqEij7gjegHkTsxhAtMYvKXQAvwmN1GUh4gc+1ogF2+jrCOIRaOGCjDuEI1DgY6RwqRP8w730JLGmzgohGNF4gYlGRJZkksCbo2gTt6WjV4sEUiFkgyRi0TmNjXAFX8ghNYoFzJFiNlVA8JPBPImUzuJlTPgwJ5kTSDddUsiZUT6uLJdYstmQO1eGLBkVB0qawfAypNmK2UbpVZwPOp9O/UByl9PjUPdKkb5ZxCaYjuPAqB8Kk+jAUlA4TLXv2FMQpyUMLnruFg8m3UA3h76CXDG4jdMBipyGMMVSZjPC+oO+mgw2MWyPP+8xA4xWIOLN0BEyhhQXY81xHqppTPfGJjO9SdtTWUWxDppprC8oDUun+Sptt2lTPoNt2kACqee2S02XColU71fUzbnZlLJD3zEh6lZA4kK3UZEG3OJb5zSBlFjsrJ0cjrSpcNiQveUFMaErM1FpgrN3lIu2qGf8QPGXsyTRaTEUy5qcVHTVGs7kRQCZVP9xRANX1LhWpXOumYR5ZX2l1TKi5aWNT7mqTYvv12tOwDMbHJsmjbv2fzuTA9LY70I5CotbqvDUQ/XVU3IY70nnXoUiqg9QAAAABJRU5ErkJggg==',
                            imageHeight: 90,
                            confirmButtonText: 'Close'
                        });
                    })
                    .catch(error => {
                        console.error('Error deleting van:', error);
                        Swal.fire({
                            title: 'Error',
                            text: 'There was a problem deleting this van. Please try again.',
                            icon: 'error',
                            confirmButtonText: 'Close'
                        });
                    });
                }
            });
        });
    });

});
</script>

{% endblock %}

